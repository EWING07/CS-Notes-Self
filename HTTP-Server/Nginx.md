# Nginx Learning Notes

1. Nginx是一款轻量级的Web服务器、反向代理服务器，由于它的内存占用少，启动极快，高并发能力强，在互联网项目中广泛应用。
   1. 处理静态文件，索引文件以及自动索引；打开文件描述符缓冲．
   2. 无缓存的反向代理加速，简单的负载均衡和容错．
   3. FastCGI，简单的负载均衡和容错．
   4. 模块化的结构。包括 gzipping, byte ranges, chunked responses,以及 SSI-filter 等 filter。如果由 FastCGI 或其它代理服务器处理单页中存在的多个 SSI，则这项处理可以并行运行，而不需要相互等待。
   5. 支持 SSL 和 TLSSNI
   
2. 正向代理与反向代理
   - 正向代理： 在客户端配置代理服务器，通过代理服务器进行互联网访问。简单来说就是翻墙需要的代理服务器。
   - 反向代理：客户端实际访问的是代理服务器，隐藏了真实服务器的IP地址。
   - 实践中客户端无法直接跟服务端发起请求的时候，我们就需要代理服务。代理可以实现客户端与服务端之间的通信,我们的Nginx也可以实现相应的代理服务。代理分为正向代理和反向代理,此文就来演示一下Nginx配置正向代理和反向代理的场景。
    ![正反向代理对比](proxy.jpg)
     - 代理服务器站在客户端那边就是正向代理,Proxy 和 Client 同属于一个 LAN（图中方框内），隐藏了客户端信息。
       - 通过代理服务器，可以突破自身IP访问限制，访问国外网站，教育网等。即，租客可以通过中介，来解决无法联系上房东的问题。
       - 通常代理服务器都设置一个较大的硬盘缓冲区，会将部分请求的响应保存到缓冲区中，当其他用户再访问相同的信息时， 则直接由缓冲区中取出信息，传给用户，以提高访问速度。即，中介手里留存了很多房源信息和钥匙，可以直接带租客去看房。
       - 上网者也可以通过这种方法隐藏自己的IP，免受攻击。即，房东并不知道租客的真实身份。PS：但是中介知道了，可能骚扰更多….
     - 代理服务器站在原始服务器那边就是反向代理,Proxy 和 Server 同属于一个 LAN（图中方框内），隐藏了服务端信息。
       - 使用反向代理，可以对客户端隐藏服务器的IP地址。即，租客并不房东知道的真实身份。
       - 反向代理服务器可以做负载均衡，根据所有真实服务器的负载情况，将客户端请求分发到不同的真实服务器上。即，二房东发现房主本人很忙，于是找到房主的妻子帮忙处理租房事宜。
       - 反向代理服务器可以对于静态内容及短时间内有大量访问请求的动态内容提供缓存服务，提高访问速度。即，二房东同样有房屋信息和钥匙。
       - 反向代理服务器可以作为应用层防火墙，为网站提供对基于Web的攻击行为（例如DoS/DDoS）的防护，更容易排查恶意软件等。还可以为后端服务器统一提供加密和SSL加速（如SSL终端代理），提供HTTP访问认证等。即，二房东可以有效的保护房东的安全。
     - 区别
       1. **正向代理其实是客户端的代理**，帮助客户端访问其无法访问的服务器资源。**反向代理则是服务器的代理**，帮助服务器做负载均衡，安全防护等。
       2. **正向代理一般是客户端架设的**，比如在自己的机器上安装一个代理软件。**而反向代理一般是服务器架设的**，比如在自己的机器集群中部署一个反向代理服务器。
       3. **正向代理中，服务器不知道真正的客户端到底是谁**，以为访问自己的就是真实的客户端。**而在反向代理中，客户端不知道真正的服务器是谁**，以为自己访问的就是真实的服务器。
       4. 正向代理和反向代理的作用和目的不同。**正向代理主要是用来解决访问限制问题**。**而反向代理则是提供负载均衡、安全防护等作用**。二者均能提高访问速度。
   
4. 负载均衡
    - 我们已经明确了所谓代理服务器的概念，那么接下来，Nginx 扮演了反向代理服务器的角色，它是依据什么样的规则进行请求分发的呢？不用的项目应用场景，分发的规则是否可以控制呢？这里提到的客户端发送的、Nginx 反向代理服务器接收到的请求数量，就是我们说的负载量。请求数量按照一定的规则进行分发，到不同的服务器处理的规则，就是一种均衡规则。所以将服务器接收到的请求按照规则分发的过程，称为负载均衡。
    - 单个服务器解决不了，我们增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分发到不同的服务器，也就是我们所说的**负载均衡**。
    - Nginx支持的负载均衡调度算法方式：
      - **weight 轮询（默认）**：接收到的请求按照顺序逐一分配到不同的后端服务器，即使在使用过程中，某一台后端服务器宕机，Nginx 会自动将该服务器剔除出队列，请求受理情况不会受到任何影响。
        这种方式下，可以给不同的后端服务器设置一个权重值（weight），用于调整不同的服务器上请求的分配率。
        权重数据越大，被分配到请求的几率越大；该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的。
      - **ip_hash**：每个请求按照发起客户端的 ip 的 hash 结果进行匹配，这样的算法下一个固定 ip 地址的客户端总会访问到同一个后端服务器，这也在一定程度上解决了集群部署环境下 Session 共享的问题。
      - **fair**：智能调整调度算法，动态的根据后端服务器的请求处理到响应的时间进行均衡分配。响应时间短处理效率高的服务器分配到请求的概率高，响应时间长处理效率低的服务器分配到的请求少，它是结合了前两者的优点的一种调度算法。但是需要注意的是 Nginx 默认不支持 fair 算法，如果要使用这种调度算法，请安装 upstream_fair 模块。
      - **url_hash**：按照访问的 URL 的 hash 结果分配请求，每个请求的 URL 会指向后端固定的某个服务器，可以在 Nginx 作为静态服务器的情况下提高缓存效率。同样要注意 Nginx 默认不支持这种调度算法，要使用的话需要安装 Nginx 的 hash 软件包。
    
4. 动静分离

    为了加快网址的解析，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度，降低原来单个服务器的压力。

5. 日志
   Nginx 日志主要有两种：access_log(访问日志) 和 error_log(错误日志)。
   1. access_log访问日志
      1. access_log 主要记录客户端访问 Nginx 的每一个请求，格式可以自定义。通过 access_log 你可以得到用户地域来源、跳转来源、使用终端、某个 URL 访问量等相关信息。
      2. log_format 指令用于定义日志的格式，语法: log_format name string; 其中 name 表示格式名称，string 表示定义的格式字符串。log_format 有一个默认的无需设置的组合日志格式。
      3. 默认的无需设置的组合日志格式
         ```conf
         log_format combined '$remote_addr - $remote_user  [$time_local]  '
                    ' "$request"  $status  $body_bytes_sent  '
                    ' "$http_referer"  "$http_user_agent" ';
         ```
          access_log 指令用来指定访问日志文件的存放路径（包含日志文件名）、格式和缓存大小，语法：`access_log path [format_name [buffer=size | off]]; `其中 path 表示访问日志存放路径，format_name 表示访问日志格式名称，buffer 表示缓存大小，off 表示关闭访问日志。
          [定义日志使用的字段及其作用](https://moonbingbing.gitbooks.io/openresty-best-practices/content/ngx/nginx_log.html)
    2. error_log错误日志
       1. error_log 主要记录客户端访问 Nginx 出错时的日志，格式不支持自定义。通过查看错误日志，你可以得到系统某个服务或 server 的性能瓶颈等。因此，将日志利用好，你可以得到很多有价值的信息。
       2. error_log 指令用来指定错误日志，语法: `error_log path [level];` 其中 path 表示错误日志存放路径，level 表示错误日志等级，日志等级包括 debug、info、notice、warn、error、crit、alert、emerg，从左至右，日志详细程度逐级递减，即 debug 最详细，emerg 最少，默认为 error。

 6. 常用命令
  ```shell
  nginx -s reopen #重启Nginx

  nginx -s reload #重新加载Nginx配置文件，然后以优雅的方式重启Nginx

  nginx -s stop #强制停止Nginx服务

  nginx -s quit #优雅地停止Nginx服务（即处理完所有请求后再停止服务）

  nginx -t #检测配置文件是否有语法错误，然后退出

  nginx -?,-h #打开帮助信息

  nginx -v #显示版本信息并退出

  nginx -V #显示版本和配置选项信息，然后退出

  nginx -t #检测配置文件是否有语法错误，然后退出

  nginx -T #检测配置文件是否有语法错误，转储并退出

  nginx -q #在检测配置文件期间屏蔽非错误信息

  nginx -p prefix #设置前缀路径(默认是:/usr/share/nginx/)

  nginx -c filename #设置配置文件(默认是:/etc/nginx/nginx.conf)

  nginx -g directives #设置配置文件外的全局指令

  killall nginx #杀死所有nginx进程
  ```

7. nginx配置文件组成

   1. nginx配置文件由三部分组成

      - 第一部分 全局块

        从配置文件到events块之间的内容，主要会设置一些影响nginx服务器整体运行的配置指令。比如：`worker_process 1;` 该值越大，可以支持的并发处理量也越多。

      - 第二部分 events块

        events块涉及的指令主要影响nginx服务器与用户的网络连接，比如：`worker_connections 1024;`支持的最大连接数。此部分比较重要，在配置的时候需灵活配置。

      - 第三部分 http全局块

        这算是nignx服务器中配置最频繁的部分，代理、缓存和日志定义等绝大多数功能和第三方模块的配置都在这边。需要注意的是：http块也可以包括*http全局块、server块*。

        - http全局块

          http全局块配置的指令包括文件引入、MIME-TYPE定义、日志自定义、连接超时间、单链接请求数上限等。

        - server块

          这块和虚拟主机有密切关系，虚拟主机从用户角度看，和一台独立的硬件主机是完全一样的，该技术的产生是为了节省互联网服务器硬件成本。

          每个http块可以包含多个server块，而每个server块就相当于一个虚拟主机。

          而每个server块也分为全局server块，以及可以同时包含多个location块。

          - 全局server块

            最常见的配置是本虚拟主机的监听配置和本虚拟主机的名称或IP配置

          - location块

            一个server可以配资多个location块

            这块的主要作用是基于nginx服务器接收的请求字符串（例如：server_name/uri-string），对虚拟主机名称（也可以是IP别名）之外的字符串（例如：前面的/uri-string）进行匹配，对特定的请求进行处理。地址定向、数据缓存和应答控制等功能，还有许多第三方模块的配置也在这里进行。

   2. 配置实例1：反向代理

      - 实现效果

        - 打开浏览器，在浏览器地址栏输入地址www.123.com，跳转linux系统tomcat主页面。

      - 准备工作

        1. 在linux系统中安装tomcat，使用默认端口8080.

           - tomcat安装文件放到linux中，解压

           - 进入tomcat的bin目录中，`./startup.sh`启动tomcat服务器

        2. 对外开放访问的端口8080

           ```shell
           firewall-cmd --list-all	#	查看已经开放的端口号
           firewall-cmd --add-port=8080/tcp --permanent	#	设置对外开放端口8080
           firewall-cmd --reload	#	重新加载
           ```

        3. 测试：在主机上打开浏览器访问tomcat服务器

      - 访问过程分析：

        ![image-20201012172348407](/Users/ewing/Documents/GitHub/CS-Notes-Self/HTTP-Server/image-20201012172348407.png)

      - 具体配置

        1. 在host文件中中配置域名映射的ip地址

        <img src="/Users/ewing/Documents/GitHub/CS-Notes-Self/HTTP-Server/image-20201012172859146.png" alt="image-20201012172859146" style="zoom:50%;" />

        2. 在nginx中进行请求转发的配置（反向代理的设置）

           <img src="/Users/ewing/Documents/GitHub/CS-Notes-Self/HTTP-Server/image-20201012173415285.png" alt="image-20201012173415285" style="zoom:50%;" />

           补充：[proxy_pass详解](https://blog.csdn.net/aerchi/article/details/84968106)

        3. 在主机浏览器中访问设置的域名

           ![image-20201012175508641](/Users/ewing/Documents/GitHub/CS-Notes-Self/HTTP-Server/image-20201012175508641.png)

